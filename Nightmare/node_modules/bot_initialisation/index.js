const discord = require("discord.js");
const Client = require('discord.js').Client;
const config = require("../../config.json");
const commandline = require('commandline');
const music = require('music');
const bot = new discord.Client();
const client = new Client();

module.exports.bot_initialisation = function (bot) {
    
    bot.on("ready", function () {
        console.log("Initialisation : ...");
        console.log("... Done");
        console.log("Hello, my name is  " + config.namebot);
    });

// Greet a member when he is connecting to the server
    bot.on("guildMemberAdd", function (member) {
        let guild = member.guild;
        // The ` notation allows to execute the code in ${} and to concatenate at the same time
        guild.defaultChannel.sendMessage(`welcome ${member.user}`);
    });

// Say hello and goodbye...
    bot.on("presenceUpdate", (newMember, message) => {
        var guild = newMember.guild;

        if (newMember.user.presence.status === "online") {
            guild.defaultChannel.sendMessage(`hi ${newMember.user}, pls type !help for commands list`);
        }

        if (newMember.user.presence.status === "offline") {
            guild.defaultChannel.sendMessage(`bye ${newMember.user}`);
        }
    });

    bot.on("presenceUpdate", (oldMember, newMember) => {
        let guild = newMember.guild;

        // Search for an "Overwatch" role in existing ones
        let playRole = guild.roles.find("name", "Overwatch");

        // If the role is not found whe leave the function
        if (!playRole)
            return;

        // Set the Overwatch Role to anyone launching the game and delete it when they leave it
        // check first if a game is being played, if we search for a game while there is none it crashes
        if (newMember.user.presence.game && newMember.user.presence.game.name === "Overwatch") {
            newMember.addRole(playRole);
        } else if (!newMember.user.presence.game && newMember.roles.has(playRole.id)) {
            newMember.removeRole(playRole);
        }
    });
    
    bot.on("message", function (message){ commandline.typed_command(message, bot); });
    bot.login(config.token);
    music(client);
};