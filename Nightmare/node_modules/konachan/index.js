var request = require('request');
const config = require("../../config.json");

// Pick a random picture from Konachan JSON file
module.exports.konachan_display = function (message) {
    let messageSplit = message.content.split(' ');
    let msgSearch = "";
    let searchOrig = "";
    for (var i = 1; i < messageSplit.length; i++) {
        if (i === 1) {
            searchOrig = messageSplit[i];
        } else {
            searchOrig = searchOrig + "+" + messageSplit[i];
        }
    }
    msgSearch = 'order:score rating:' + config.pic_safe + ' ' + searchOrig;
    console.log(msgSearch);
    request.get('https://konachan.com/post.json', {
        qs: {
            limit: 200,
            tags: msgSearch
        }
    }, function (error, response, body) {
        if (error) {
            message.reply('a error occured!');
        }
        if (!error && response.statusCode === 200) {
            try {
                body = JSON.parse(body);
            } catch (e) {
                console.log(e);
            }
            if (typeof (body) !== 'undefined' && body.length > 0) {
                var randome = random(0, body.length);
                randome = Math.floor(randome);
                if (typeof (body[randome]) !== 'undefined' && typeof (body[randome].file_url) !== 'undefined') {
                    message.channel.sendMessage(`http://${body[randome].file_url.substring(2)}`, function (err, message) {
                        if (err)
                            return console.log(err);
                    });
                } else {

                }
            } else {
                message.reply('nsfw-images.nothing-found');
            }
        }
    });
};

var random = function (min, max) {
    return Math.floor(Math.random() * (max - min) + min);
};

